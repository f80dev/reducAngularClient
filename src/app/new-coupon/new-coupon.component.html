

<mat-card class="app-card" style="margin:0px;padding:3px;background-color: #8f8f8f;">
  <table style="width: 100%" *ngIf="!showOldCoupon"><tr>
    <td>
      <button mat-button mat-flat-button
              class="large-button"
              id="btnShowModels"
              style="margin-left:10px;"
              (click)="showOldCoupon=true">
        Utiliser un modèle
      </button>
    </td>
    <td style="text-align: right;">
      <img [src]="coupon.picture" style="max-width: 75px;margin-right: 15px;">
    </td>
  </tr></table>

  <app-tuto [delay]="5" *ngIf="!showOldCoupon" [force]="true"
            label="Remplissez bien les 5 étapes pour décrire votre promotion. Les résumés au début de chaque section présentent l'information saisie sous un format lisible. Si vous ne voyez pas par oû commencer, consulter les modèles disponibles">
  </app-tuto>

  <mat-card-content class="app-card-content" style="text-align: left;margin:0;padding:0;">

    <app-old-coupons *ngIf="showOldCoupon"
                     title="Utilisez un modèle pour votre nouvelle promotion"
                     [shop]="{'_id':coupon.shop,'owner':userid}"
                     [filter]="tags"
                     [level]="level"
                     (cancel)="showOldCoupon=false"
                     (select)="selectOldAsModel($event)">
    </app-old-coupons>

    <mat-vertical-stepper style="background: none;margin:0px;padding:0px" *ngIf="!showOldCoupon">
      <mat-step title="La nature de la promotion permet de décrire les éléments principaux : ce que l'on gagne, une phrase d'accroche, le gain maximum">
        <ng-template matStepLabel>Décrire votre promotion</ng-template>


        <div class="detail_promo">
          <div *ngIf="level<1" style="font-size: x-small">Résumé de votre saisie:<br></div>
          {{buildCouponTeaser(coupon,shopname)}}
        </div>
        <br>

        <app-tuto *ngIf="level<1 && focusElt=='symbol'"
                  label="Vous pouvez utiliser des emojis pour représenter l'unité de votre promo (par exemple pour 'croissant')"
                  [delay]="5">
        </app-tuto>


        <app-tuto label="Commencer par préciser ce que l'on gagne dans la promotion, au singulier et si possible en 1 seul mot. Par exemple : minute, euro, % de l'addition"
                  *ngIf="focusElt=='unity'"></app-tuto>

        <mat-form-field class="form-field-style" style="width: 60%;margin-right: 5%;">
          <input type="text" matInput
                 id="txtUnity" (change)="refresh()"
                 title="On détermine l'unité de la promotion. Dit autrement : Ce que le client gagne."
                 (focus)="focusElt='unity'"
                 placeholder="Unitée offerte"
                 [(ngModel)]="coupon.unity">
        </mat-form-field>

        <mat-form-field class="form-field-style" style="width: 30%;">
          <input type="text" matInput max="3"
                 (focus)="focusElt='symbol'"
                 title="Le symbole est utilisé pour abrégé l'unité dans les descriptions. Il est pertinant d'utiliser un emoji si c'est possible"
                 id="txtSymbol" (change)="refresh()"
                 placeholder="Symbole de l'unité"
                 [(ngModel)]="coupon.symbol">
        </mat-form-field>

        <mat-checkbox [(ngModel)]="coupon.breakable"
                      *ngIf="level>0.5" (focus)="focusElt='breakable'"
                      (change)="changeMax()">unité fractionnable (Exemple: 3.4 {{coupon.symbol}})
        </mat-checkbox>
        <br><br>

        <app-tuto label="Comme la valeur des promotions de ReducShare est variable, il sera pertinent de fixer un maximum par client. Par exemple: 25 (pour une remise sur un prix) ou 3 cafés offerts"
                  *ngIf="focusElt=='max'"></app-tuto>

        <mat-checkbox id="chkPlafond" [(ngModel)]="hasMax"
                      *ngIf="level>0.5"
                      (change)="changeMax()">
          Plafonner le gain
        </mat-checkbox>
        <br>


        <mat-form-field class="form-field-style" *ngIf="hasMax">
          <input matInput type="number" (change)="refresh()" (update)="refresh()"
                 (focus)="focusElt='max'"
                 id="txtMaxGainByUser"
                 title="Plafonner les gains permet d'éviter qu'un client ne 'vide' le stock réservé à la promotion"
                 placeholder="Le client peut gagner au maximum ..." [(ngModel)]="coupon.max">
        </mat-form-field>
        <br>

        <app-tuto *ngIf="focusElt=='breakable'" id="tutoBreakable"
                  label="Préciser si l'objet de la promotion est fractionnable (en morceau) ou entier. Exemple : un café n'est pas fractionnable, un % sur un prix l'est">
        </app-tuto>

        <app-tuto label="Pour toute promotion on va préciser dans quel cadre le client peut utiliser la promotion. Par exemple : pour tout achat hors weekend, pour tout achat d'un montant minimum de ..."
                  *ngIf="focusElt=='conditions'"></app-tuto>

        <mat-form-field class="form-field-style">
          <textarea matInput rows="3"
                    id="txtConditions"
                    (focus)="focusElt='conditions'"
                    title="Condition d'application de l'offre / de la promo"
                    placeholder="Offre valable ..."
                    [(ngModel)]="coupon.conditions"
                    (change)="normalize_conditions(coupon)"></textarea>
        </mat-form-field>

        <mat-form-field class="form-field-style">
          <input type="text" matInput
                 id="txtLabel"
                 title="{{'On détermine une phrase d\'accroche pour inciter les clients à prendre le coupon' | trans}}"
                 placeholder="Introduction (teaser) de la promotion" [(ngModel)]="coupon.label">
        </mat-form-field>


        <mat-form-field *ngIf="level>0.6" class="form-field-style">
          <input type="text" matInput
                 id="txtWebSite"
                 (focus)="focusElt='website'"
                 placeholder="{{'Site web pour infos complémentaires' | trans}}"
                 [(ngModel)]="coupon.website">
        </mat-form-field>


        <!--<mat-checkbox style="width: 20%;margin-right: 5%;" [(ngModel)]="coupon.pluriel">avec une 's' au pluriel</mat-checkbox>-->
      </mat-step>


      <mat-step title="L'ajout d'un visuel est important pour l'impact de la promotion">
        <ng-template matStepLabel>Ajouter un visuel</ng-template>

        <!--Gestion du visuel-->

        <app-tuto *ngIf="focusElt=='symbol'"
          label="Il est bon d'ajouter un visuel pour renforcer l'attractivité de votre promotion. Cela peut être une photo ou un emoji"></app-tuto>
        <!--<div style="width: 100%;text-align: center;">-->


          <!-- Présentation du mini visuel -->
          <!--<table style="display: inline-block;width:100%;"><tr>-->
            <!--<td style="text-align: center;">-->
              <!--<span *ngIf="coupon.picture?.length>0">Mini visuel associé à votre promotion</span><br><br>-->
              <!--<app-visual [picture]="coupon.picture"></app-visual>-->
            <!--</td>-->
            <!--<td style="text-align: center;">-->
              <!--<button mat-button mat-flat-button-->
                      <!--(click)="addImage('picture',300,300,true)">-->
                <!--Images-->
              <!--</button>-->
            <!--</td>-->
          <!--</tr></table>-->

        <!--</div>-->

        <div *ngIf="coupon.visual?.length>0" style="width:100%;text-align: center;">
          Visuel du coupon<br><br>
          <img
               [src]="coupon.visual"
               class="visual-coupon"
               (click)="addImage('visual',800,220,false)"
          >
        </div>
      </mat-step>


      <mat-step (click)="focusElt='stepIncrease'" title="Il est important de définir les gains de la promotion en fonction de ce que fait le client du coupon" >
        <ng-template matStepLabel>Détailler l'augmentation de la promotion</ng-template>

        <app-tuto *ngIf="focusElt=='stepIncrease'"
                  id="tutoStepIncrease"
                  label="La force de reducShare est de pouvoir augmenter la valeur de la promotion du client lorsque celui ci la partage. Ainsi dans cette section vous préciser la façon dont la promotion se comporte">
        </app-tuto>

        <div class="detail_promo">
          le client gagne immédiatement {{coupon.direct_bonus}}{{coupon.symbol}}
          lorsqu'il flash la promotion. Il gagne 1{{coupon.symbol}} supplémentaire chaque fois qu'il partage {{coupon.nb_partage}} fois la promotion, et {{coupon.pay_bonus}}{{coupon.symbol}} supplémentaire(s) chaque fois qu'un coupon qu'il a distribué est utilisé.
        </div>

        <br>


        <mat-form-field class="form-field-style">
          <input matInput type="number"
                 id="txtDirectBonus"
                 (focus)="focusElt='direct_bonus'"
                 title="Promotion directement récupéré à l'obtention de la promotion"
                 placeholder="Bonus immédiat (en {{coupon.symbol}})"
                 [(ngModel)]="coupon.direct_bonus">
        </mat-form-field>
        <app-tuto *ngIf="focusElt=='direct_bonus'" id="tutoDirectBonus"
                  label="Le bonus immédiat est important car c'est celui qui donne envie au client de capturer la promotion. Si le client ne récupére pas la promotion, le vendeur ne peut pas espérer qu'il la partagera">
        </app-tuto>


        <mat-form-field class="form-field-style">
          <input matInput type="number"
                 (focus)="focusElt='share_bonus'"
                 id="txtShareBonus" title="Bonus récupérer à chaque ouverture du coupon partagé"
                 placeholder="Nombre de partages pour 1{{coupon.symbol}} supplémentaire" [(ngModel)]="coupon.nb_partage">
        </mat-form-field>

        <app-tuto *ngIf="focusElt=='share_bonus'"
                  id="tutoShareBonus"
                  label="Attention, le bonus a chaque partagee doit resté faible car il peut augmenter rapidement sans pour autant générer de chiffres d'affaires">
        </app-tuto>

        <mat-form-field class="form-field-style" *ngIf="coupon.final_bonus>0 || level>1">
          <input matInput type="number"
                 (focus)="focusElt='final_bonus'"
                 id="txtFinalBonus" title="Bonus récupérer a l'utilisation du coupon"
                 placeholder="Bonus récupérer à l'utilisation du coupon"
                 [(ngModel)]="coupon.final_bonus">
        </mat-form-field>

        <app-tuto *ngIf="focusElt=='final_bonus'"
                  id="tutoFinalBonus"
                  label="Dans le cas ou la promotion est utilisable plusieurs fois (dans ce cas il s'agirat plutôt d'un programme de fidélité) on pourra indiquer un bonus à l'utilisation de la promotion">
        </app-tuto>


        <br>
        <mat-form-field class="form-field-style">
          <input matInput type="number"
                 id="txtPayBonus"
                 (focus)="focusElt='pay_bonus'"
                 title="Bonus obtenu lorsqu'un coupon partagé est utilisé chez le commercant"
                 placeholder="Bonus (en {{coupon.symbol}}) par achat obtenu par vos partages" [(ngModel)]="coupon.pay_bonus">
        </mat-form-field>
      </mat-step>

      <app-tuto *ngIf="focusElt=='pay_bonus'"
                id="tutoPayBonus"
                label="On peut attribuer un bonus au client lorsqu'un des coupons qu'il a repartagé à été utilisé par celui qui l'a reçu (donc à générer un achat)">
      </app-tuto>



      <mat-step name="step5" title="La maitrise du budget de la promotion est important. On l'obtient en limitant la promo dans le temps et en volume">
        <ng-template matStepLabel>Maitriser le budget</ng-template>

        <app-tuto id="tutoStep5" label="Plusieurs limites vous permette de maitriser la promotion en terme de coût, de stock, de durée de validité">
        </app-tuto>


        <div class="detail_promo">
          La promotion dure <span *ngIf="coupon.duration_jours!=null && coupon.duration_jours>0">{{coupon.duration_jours}} jour(s) </span>
          <span *ngIf="coupon.duration_hours!=null && coupon.duration_hours>0">{{coupon.duration_hours}} heures</span>,
        et s'interrompt si le stocke de {{coupon.stock}} {{coupon.symbol}} à été distribué.
          La promotion ne peut plus être distribuée si {{coupon.max_coupon}} ont été partagées.
        <br><br>
        </div>

        <mat-form-field class="form-field-style" style="width: 40%;margin-right:10%;">
          <input matInput id="txtDays" title="On détermine le nombre de jours de validité de la promotion"
                 type="number" min="0" step="any"  placeholder="Durée (En Jours)" [(ngModel)]="coupon.duration_jours">
        </mat-form-field>

        <mat-form-field class="form-field-style" style="width: 40%;">
          <input matInput id="txtHours"
                 title="On détermine le nombre d'heure de validité de la promotion. 0.5 désignera une demi heure"
                 type="number" min="0" step="any" placeholder="Durée (En Heure)" [(ngModel)]="coupon.duration_hours">
        </mat-form-field>
        <br>

        <mat-form-field class="form-field-style">
          <input matInput type="number"
                 id="txtStock"
                 title="Le stock permet d'interrompre automatiquement la promotion lorsque le stock qui lui est réservée tombe a zéro"
                 placeholder="Stock (en {{coupon.symbol}}) destiné à la promotion"
                 [(ngModel)]="coupon.stock">
        </mat-form-field>

        <mat-form-field *ngIf="level>0.5" class="form-field-style">
          <input matInput
                 type="number"
                 id="txtMaxShare" title="Le nombre maxium de partage permet de limiter le partage du coupon"
                 placeholder="Nombre maximum de partages" [(ngModel)]="coupon.max_coupon">
        </mat-form-field>
      </mat-step>

      <app-tuto *ngIf="focusElt=='title'"
                label="Ce titre ne sera pas visible du client. Il est fait pour vous aidez à retrouver votre promotion pour la réutiliser depuis la liste des modèles">
      </app-tuto>


      <mat-step>
        <ng-template matStepLabel>Références de la promo</ng-template>
        <mat-form-field class="form-field-style">
          <input type="text" matInput
                 id="txtTitle" title="Le titre est utilise par l'enseigne pour s'y retrouver dans la liste des promos"
                 (focus)="focusElt='title'"
                 placeholder="{{'Titre de la promotion (non visible du client)' | trans}}"
                 [(ngModel)]="coupon.title">
        </mat-form-field>

      </mat-step>

    </mat-vertical-stepper>
  </mat-card-content>

  <mat-card-actions class="app-card-action">
    <mat-progress-spinner *ngIf="config.waiting"></mat-progress-spinner>
    <button mat-flat-button class="app-button"
            id="btnValide"
            *ngIf="coupon.label?.length>0 && coupon.title?.length>0 && !config.waiting" mat-button
            (click)="addcoupon(coupon)">Valider</button>

    <button mat-flat-button
            id="btnCancel"
            *ngIf="!config.waiting"
            class="app-button"
            mat-button (click)="cancel()">Annuler</button>
    &nbsp;&nbsp;&nbsp;<br><br>
  </mat-card-actions>
</mat-card>


