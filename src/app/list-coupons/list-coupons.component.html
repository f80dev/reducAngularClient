<div *ngFor="let coupon of coupons | orderBy:sort" style="width:100%;padding: 0px;margin-top:3px;">


  <mat-expansion-panel [expanded]="isVisible(coupon)"
                       class="app-card"
                       (closed)="showCoupon(coupon,false)"
                       (opened)="showCoupon(coupon,true)"
                       style="background-color: #8f8f8f;padding:0px !important;"
                       *ngIf="coupon.flip || coupon.visual==null || coupon.visual?.length==0 || coupon.origin==coupon._id">
    <mat-expansion-panel-header collapsedHeight="50px" expandedHeight="50px"
                                class="app-card-header"
                                name="promoTitle">

      <!-- Titre principal du coupon-->
      <div style="width: 100%;margin-left:5px;margin-top:0px;">
        <!--<div style="width: 40px;height:40px;display: inline-block;"-->
             <!--(click)="_flip(coupon)"-->
             <!--class="header-image">-->
        <!--</div>-->

        <!--Affichage des coupon pour la carte-->
        <span *ngIf="coupon.origin==coupon._id && coupon.owner!=user._id">
          {{coupon.shopname}}: {{coupon.label}}<br>
          Gagnez jusqu'à {{coupon.max}} {{coupon.unity}}({{coupon.symbol}})
        </span>

          <!--Affichage des coupons origines pour leur propriétaire-->
          <div *ngIf="coupon.origin==coupon._id && coupon.owner==user._id">
            {{coupon.title}}

            <span *ngIf="!isVisible(coupon)">
              &nbsp;&nbsp;- <app-timer [end]="coupon.dtEnd"></app-timer>
            </span>
          </div>


        <!--Affichage des coupons copiés pour les non propriétaire pour la carte-->
          <div *ngIf="coupon.origin!=coupon._id && coupon.owner==user._id">

            <!--sur titre-->
            <span *ngIf="coupon.visible!=2">{{coupon.label}}</span>
            <br>

            <span *ngIf="coupon.visible==2">
              Rendez vous "{{coupon.shopname}}"
            </span>

            <!-- Sous-titre-->
            <span *ngIf="coupon.visible==1">
              <span style="font-size: x-small;" *ngIf="coupon.canbedeal && coupon.max>0">
                Partagez la promo pour gagner jusqu'à {{coupon.max}}{{coupon.symbol}}
              </span>

                <!--Si le coupon ne peut plus être distribué-->
              <span *ngIf="!coupon.canbedeal || coupon.visible==2">
                Récupérer {{coupon.gain}}{{coupon.symbol}} offert
              </span>
            </span>

            <span *ngIf="coupon.visible==0" style="font-size: x-small;">
              {{coupon.shopname}}
            </span>

            <span *ngIf="coupon.visible==2" style="font-size: x-small;">
              <br>
              Avant le {{(coupon.dtEnd*1000) | date:formatDate}} (il reste <app-timer [end]="coupon.dtEnd"></app-timer>)
            </span>
          </div>


        <!--Affichage des coupons origines pour leur propriétaire-->
        <div *ngIf="coupon.owner==user._id && coupon.origin==coupon._id" style="font-size: small;">
          <small>{{coupon.share}}/{{coupon.max_coupon}} coupons distribués</small>
          <span *ngIf="coupon.max>0 && (coupon.gain/coupon.max)>0.8">
            (max:{{coupon.max}})
          </span>
        </div>

      </div>

    </mat-expansion-panel-header>
        <div style="margin:0px !important;" class="app-card-content">

          <!-- Section destinée à l'imprression -->
          <div id="print-section-{{coupon._id}}" style="display: none;">
            <app-print-coupon [coupon]="coupon"></app-print-coupon>
          </div>

          <!--Visuel du coupon-->
          <table style="width:100%;vertical-align: top;text-align: center;"><tr>
            <td style="text-align: center;width: fit-content;max-width: 40%;">
              <!--Visuel du coupon-->

              <div *ngIf="coupon.visible==0 && coupon.picture?.length>0 && (coupon.origin!=coupon._id || config.width_screen>350)">
                <app-visual [picture]="coupon.visual"
                            (click)="coupon.visible>0"
                            width="33vw" max-width="230px" max-height="180px">
                </app-visual>
              </div>

              <!--QRCode du coupon-->

              <span *ngIf="coupon.visible==2  && (coupon.breakable || coupon.gain>=1)"><small>Montrez le QR-code</small></span><br>

              <a [href]="coupon.url" target="_blank"
                 *ngIf="coupon.visible==1 || (coupon.visible==2 && (coupon.breakable || coupon.gain>=1))">
                <qr-code [value]="coupon.url" name="qrcode"
                         style="width:150px;height: 140px;margin:0px;"
                         ngxClipboard [cbContent]="coupon.url"
                         [size]="120">
                </qr-code>
                <br>
              </a>
              <span *ngIf="coupon.visible==2  && (coupon.breakable || coupon.gain>=1)"><small>au vendeur</small><br></span>

            </td>
            <td style="text-align: center;vertical-align: top;">

              <!--Zone réservé au client de base-->
              <div style="margin-top:10px;line-height:100%;display:inline-block;font-size: larger;"
                   *ngIf="coupon._id!=coupon.origin && coupon.visible==0">

                <div style="font-size: 2em;" *ngIf="coupon.promocodes.length==0">
                  <!--Affiche en mode decimal (breakable et >1)-->
                  <span *ngIf="coupon.breakable || coupon.gain>=1">
                    {{coupon.gain | number:'1.0-1'}}{{coupon.symbol}}
                  </span>

                  <!--Affiche en mode decimal (breakable et >1)-->
                  <span *ngIf="!coupon.breakable && coupon.gain<1">
                    {{coupon.gain*100 | number:'1.0-0'}}% {{coupon.symbol}}
                  </span>

                </div>

                <span style="font-size: 2em;" *ngIf="coupon.promocodes.length>0">
                  {{showPromoCode(coupon.gain,coupon.promocodes)}}
                </span>

                <br>
                <span style="font-size: small;padding: 0px;">gagné(es)</span>
                <span *ngIf="coupon.max>0 && coupon.gain/coupon.max>0.8">(/{{coupon.max}})</span>
                <br><br><br>il reste <app-timer [end]="coupon.dtEnd"></app-timer><br>
                <span *ngIf="coupon.stock<10">Encore {{coupon.stock}}{{coupon.symbol}} à gagner</span>
              </div>


              <div *ngIf="coupon.canbedeal && (coupon.visible==1 || (coupon.origin==coupon._id && coupon.share==0))">
                <span style="margin-bottom: 6px;" *ngIf="user.level<0.8">Bonus client, coupon :</span>
                <br>
                <table style="text-align: left;display: inline-block;font-size:small;line-height: 95%;" cellpadding="1" name="zoneInfo">
                  <!-- <tr *ngIf="coupon.direct_bonus>0"><td>Immédiat</td><td style="text-align: right;">+{{coupon.direct_bonus}}{{coupon.symbol}}</td></tr> -->
                  <tr *ngIf="coupon.share_bonus>0"><td>Partagé</td><td style="text-align: right;">+{{coupon.share_bonus | number:'1.0-2'}}{{coupon.symbol}}</td></tr>
                  <tr *ngIf="coupon.pay_bonus>0"><td>Transformé</td><td style="text-align: right;">+{{coupon.pay_bonus}}{{coupon.symbol}}</td></tr>
                  <tr *ngIf="coupon.final_bonus>0"><td>Utilisé</td><td style="text-align: right;">+{{coupon.final_bonus}}{{coupon.symbol}}</td></tr>
                </table>
                <br>
                <span style="font-size: medium" *ngIf="coupon.visible==1">
                <br>Il reste <app-timer [end]="coupon.dtEnd"></app-timer> et
                  <span *ngIf="coupon.stock<10">{{coupon.stock}}{{coupon.symbol}}</span>

              </span>

              </div>

              <div style="min-width:200px;" *ngIf="coupon.visible==2">
                <div style="display: inline-block;" *ngIf="coupon.breakable || coupon.gain>=1">
                  <small>et bénéficiez de</small> <br><br>
                  <span style="font-size: xx-large;">{{coupon.gain}}{{coupon.symbol}}</span><br>
                </div>

                <div style="font-size: medium;max-width:200px;display: inline-block;"
                     *ngIf="!coupon.breakable && coupon.gain<1">
                  Vous n'avez pas encore assez pour utiliser le coupon
                </div>

                <br>
                <div *ngIf="coupon.breakable || coupon.gain>=1">
                  <div style="width:80%;display:inline-block;line-height: 90%;margin-top:5px;">{{coupon.conditions}}</div>
                  <br><br>
                  Localiser le point de vente :
                  <button mat-button mat-flat-button
                          name="btnMap"
                          class="small-icon-button"
                          *ngIf="coupon._id!=coupon.origin"
                          title="Localiser l'enseigne proposant la réduction"
                          mat-icon-button  (click)="showAddress(coupon.shop_complete)">
                    <mat-icon>my_location</mat-icon>
                  </button>
                </div>

              </div>
              <!--La table des gains-->

              <!--Zone réserver au créateur-->
              <div *ngIf="coupon._id==coupon.origin && coupon.owner==user._id && coupon.share>0" style="font-size: small;">
                <br>
                <table style="display:inline-block;text-align: left;line-height: 90%;" cellpadding="3px">
                  <tr *ngIf="coupon.share>0">
                    <td style="text-align: right;font-size: large;"><strong>{{coupon.share | number:'1.0-0'}}</strong>&nbsp;</td>
                    <td>partages (/{{coupon.max_coupon}})<br></td>
                  </tr>
                  <tr *ngIf="coupon.share>0"><td><br></td><td></td></tr>
                  <tr *ngIf="user.level>1">
                    <td style="text-align: right;">{{coupon.gain_total | number:'1.0-1'}} {{coupon.symbol}}</td>
                    <td>proposé(es)</td>
                  </tr>
                  <tr>
                    <td style="text-align: right;">{{coupon.stock | number:'1.0-1'}}{{coupon.symbol}}</td>
                    <td>
                      en stock
                      <mat-icon (click)="updateStock(coupon)" style="cursor:pointer;font-size: small;">edit</mat-icon>
                    </td>
                  </tr>
                </table>

              </div>

            </td>
          </tr></table>


          <app-tuto *ngIf="isVisible(coupon) && coupon.visible==1" [delay]="1" [duration]="30"
                    label="Le lien du coupon est disponible dans le presse-papier, vous pouvez l'envoyer par WhatsApp, SMS, Messenger ... etc ...">
          </app-tuto>

          <app-tuto [duration]="15" *ngIf="coupon.canbedeal && coupon.origin==coupon._id && coupon.visible==1 && coupon.share==0"
                    label="Commencez la distribution de votre coupon en l'imprimant ou en l'envoyant a votre réseau par SMS, facebook, whatsapp">
          </app-tuto>

          <div style="width: 100%;text-align: center;font-size: medium;color:lightgrey;"
               name="zoneConditions"
               *ngIf="coupon.origin!=coupon._id && coupon.visible!=0 && !coupon.canbedeal">
            <br>
            <strong>Rappel des conditions d'application:</strong><br>
            Offre valable pour {{coupon.conditions}}
          </div>

          <app-tuto *ngIf="!coupon.canbedeal && coupon.origin!=coupon._id"
                    label="Le coupon ne peut plus être distribué, mais vous pouvez l'utiliser au près du vendeur">
          </app-tuto>

          <app-tuto *ngIf="user.level>0.8 && coupon.owner==user?._id && coupon.origin==coupon._id" [delay]="10" button="printer"
                    label="A tout instant, vous pouvez imprimer une affiche pré-fabriquée pour votre promotion">
          </app-tuto>

          <app-tuto *ngIf="coupon.origin==coupon._id && coupon.share>0 && coupon.canbedeal && coupon['flip']"
                    [delay]="5" button="not_interested"
                    label="Vous pouvez interrompre la distribution d'une promotion à tout instant">
          </app-tuto>

        </div>


    <!--Info sur le coupon-->

    <mat-action-row class="app-card-action">

      <div *ngIf="coupon.owner==user?._id">

        <!--<button mat-button mat-flat-button mat-icon-button (click)="showInfos(coupon)">-->
        <!--<mat-icon>attach_money</mat-icon>-->
        <!--</button>-->

        <button *ngIf="user.level>0.8 && coupon._id==coupon.origin && isVisible(coupon) && coupon.canbedeal"
                class="small-icon-button"
                mat-button
                (click)="openPrinter(coupon)"
                name="btnPrint"
                title="Imprimer une affiche de votre bon plan"
                mat-flat-button mat-icon-button>
          <mat-icon>printer</mat-icon>
        </button>

        <button *ngIf="user && coupon.shop_complete?.owner!=user._id && user.level>0.5"
                mat-button
                mat-flat-button mat-icon-button
                class="small-icon-button"
                (click)="addfollow(user._id,coupon.shop)"
                title="Recevoir les prochaines promotion de '{{coupon.shop_complete?.name}}'">
          <mat-icon *ngIf="user && !isfollower(coupon.shop)">favorite</mat-icon>
          <mat-icon *ngIf="user && isfollower(coupon.shop)">remove_shopping_cart</mat-icon>
        </button>

        <button *ngIf="user.level>0.5 && coupon._id==coupon.origin && isVisible(coupon) && coupon.canbedeal"
                mat-button
                (click)="stopDeal(coupon)"
                class="small-icon-button"
                title="Fermer prématurément la promotion"
                mat-flat-button mat-icon-button>
          <mat-icon>not_interested</mat-icon>
        </button>


        <button mat-button mat-flat-button
                mat-icon-button
                class="small-icon-button"
                name="btnRemove"
                (click)="remove(coupon)">
          <mat-icon>delete</mat-icon>
        </button>

        <button mat-button mat-flat-button
                mat-icon-button
                class="small-icon-button"
                name="btnEdit"
                *ngIf="coupon.share==0 && coupon.origin==coupon._id"
                (click)="onedit.emit(coupon)">
          <mat-icon>create</mat-icon>
        </button>


        <div *ngIf="!coupon.closed" style="display: inline-block;margin:0;padding:0;">
          <button mat-button mat-flat-button
                  *ngIf="coupon.website!=null && coupon.website?.length>0 && coupon.owner!=user._id"
                  mat-icon-button
                  class="small-icon-button"
                  name="btnHelp"
                  (click)="openHelp(coupon.website)">
            <mat-icon>help</mat-icon>
          </button>

          <button mat-button mat-flat-button
                  name="btnShare"
                  *ngIf="coupon.canbedeal && user.level<1"
                  title="Partager le coupon pour augmenter votre promotion / réduction"
                  (click)="showCode(coupon,1)">
            <mat-icon>share</mat-icon>&nbsp;
            <span *ngIf="coupon.origin!=coupon._id">
              Gagner plus
            </span>

            <span *ngIf="coupon.origin==coupon._id">
              Distribuer
            </span>

          </button>

          <button mat-button mat-flat-button mat-icon-button
                  name="btnShareAdvanced"
                  class="small-icon-button"
                  *ngIf="coupon.canbedeal && user.level>=1"
                  title="Partager le coupon pour augmenter votre promotion / réduction"
                  (click)="showCode(coupon,1)">
            <mat-icon>share</mat-icon>
          </button>

          <button mat-button mat-flat-button mat-icon-button
                  name="btnUseAdvanced"
                  *ngIf="coupon.origin!=coupon._id && user.level>0.8"
                  title="Utiliser votre coupon pour avoir votre réduction"
                  (click)="showCode(coupon,2)">
            <mat-icon>done</mat-icon>
          </button>

          <button mat-button mat-flat-button
                  name="btnUse"
                  *ngIf="coupon.origin!=coupon._id && user.level<=0.8"
                  title="Utiliser votre coupon pour avoir votre réduction"
                  (click)="showCode(coupon,2)">
            <mat-icon>done</mat-icon>&nbsp;
            Utiliser
          </button>


        </div>
      </div>

      <div *ngIf="coupon.owner!=user?._id">
        <button *ngIf="coupon._id==coupon.origin && isVisible(coupon) && coupon.canbedeal" mat-button
                (click)="flash(coupon)"
                name="btnRecup"
                title="Récupérer ce coupon pour le mettre dans vos promotions"
                mat-flat-button>
          Récupérer
        </button>
      </div>
    </mat-action-row>
  </mat-expansion-panel>




  <!--Fin du coupon-->





  <div class="visual-coupon" *ngIf="!coupon.flip && coupon.visual?.length>0 && coupon.origin!=coupon._id" (click)="_flip(coupon)">
    <img [src]="coupon.visual"
         style="position:absolute;z-index:0;top:0;left:0;width:100%;height:100%;object-fit: cover;object-position: 50% 50%;">

    <div style="z-index: 100;position: absolute;left:10%;top:10%;width:80%;max-width: 500px;font-size:x-large;">
      <span [ngStyle]="{color:coupon.ink_color}">{{coupon.label}}</span><br>
      <span style="font-size: small">(vous pouvez avoir jusqu'à {{coupon.max}}&nbsp;{{coupon.unity}})</span>
      <br><br>
      <div [ngStyle]="{'font-size':'large',color:coupon.ink_color}" *ngIf="coupon.max>0">
        Pour l'instant vous avez
        <span *ngIf="coupon.breakable || coupon.gain>=1">{{coupon.gain | number:'1.0-1'}}</span>
        <span *ngIf="!coupon.breakable && coupon.gain<1">{{coupon.gain*100 | number:'1.0-0' }}% de 1</span>
        {{coupon.symbol}}
        <br>
      </div>
    </div>
    <div style="z-index: 110;position: absolute;left:0;top:75%;width:100%;text-align: right;max-width:720px;">
      <button *ngIf="user.level<1 && coupon._id!=coupon.origin"
              style="display: inline-block;margin-right:40px;"
              mat-button
              name="btnInfo"
              title="Avoir le détail de la promo"
              mat-flat-button>
        En savoir plus
      </button>
    </div>
  </div>


</div>



