<mat-card *ngFor="let coupon of coupons | orderBy:sort" class="app-card" style="background-color: #8f8f8f;">
  <mat-card-header class="app-card-header" name="promoTitle" (click)="showCoupon(coupon)">
    <div mat-card-avatar class="header-image"></div>


    <!-- Titre principal du coupon-->
    <mat-card-title style="font-size: medium;">
      <!--Affichage des coupons origine pour les non propriétaire - destiné à la carte -->
      <span *ngIf="coupon.origin==coupon._id && coupon.owner!=user._id">
        {{coupon.shopname}}: {{coupon.label}}
      </span>

      <!--Affichage des coupons copiés pour leur propriétaire-->
      <span *ngIf="coupon.origin!=coupon._id && coupon.owner==user._id">
        {{coupon.shopname}}: {{coupon.label}}
        <span *ngIf="!isVisible(coupon)">- <app-timer [end]="coupon.dtEnd"></app-timer></span>
      </span>

      <!--Affichage des coupons origines pour leur propriétaire-->
      <span *ngIf="coupon.origin==coupon._id && coupon.owner==user._id">
        {{coupon.title}}

        <mat-icon style="font-size: small;margin:0;padding:0;display: inline;cursor: pointer;" id="btnEdit"
                  (click)="onedit.emit(coupon)"
                  *ngIf="coupon.share==0 && coupon.origin==coupon._id">
          create
        </mat-icon>

        <span *ngIf="!isVisible(coupon)">
          - <app-timer [end]="coupon.dtEnd"></app-timer>
        </span>

      </span>

    </mat-card-title>


    <span class="spacer"></span>
    <div style="display: inline-block;cursor: pointer;">
      <mat-icon *ngIf="!isVisible(coupon)">arrow_drop_down</mat-icon>
      <mat-icon *ngIf="isVisible(coupon)">arrow_drop_up</mat-icon>
    </div>


    <!-- La partie sous-titre -->
    <mat-card-subtitle>

      <app-tuto [delay]="20" *ngIf="!isVisible(coupon)"
                label="Cliquer sur le titre pour ouvrir la promotion">
      </app-tuto>

      <!--Affichage des coupons origine pour les non propriétaire pour la carte-->
      <div *ngIf="(coupon.owner!=user._id || coupon.origin!=coupon._id)">
        <span *ngIf="coupon.canbedeal && coupon.max>0">
          jusqu'a {{coupon.max}}{{coupon.symbol}} offert {{coupon.conditions}}
        </span>

        <!--Si le coupon ne peut plus être distribué-->
        <span *ngIf="!coupon.canbedeal">
          Récupérer {{coupon.gain}}{{coupon.symbol}} offert
        </span>
      </div>


      <!--Affichage des coupons origines pour leur propriétaire-->
      <div *ngIf="coupon.owner==user._id && coupon.origin==coupon._id">
             {{coupon.share}}/{{coupon.max_coupon}} coupons distribués
        <span *ngIf="coupon.max>0 && (coupon.gain/coupon.max)>0.8">
          (max:{{coupon.max}})
        </span>

      </div>
    </mat-card-subtitle>

  </mat-card-header>

  <mat-card-content class="app-card-content" *ngIf="isVisible(coupon)">

    <!-- Section destinée à l'imprression -->
    <div id="print-section-{{coupon._id}}" style="display: none;">
      <app-print-coupon [coupon]="coupon"></app-print-coupon>
    </div>

    <!--Visuel du coupon-->
    <table style="width:100%;vertical-align: top;text-align: center;"><tr>
      <td style="text-align: center;width: fit-content;max-width: 40%;">
        <!--Visuel du coupon-->

        <div *ngIf="(coupon.showCode==null || !coupon.showCode) && coupon.picture?.length>0 && (coupon.origin!=coupon._id || config.width_screen>350)">

          <app-visual [picture]="coupon.picture" (click)="coupon.showCode=true"></app-visual>

        </div>

        <!--QRCode du coupon-->

        <a [href]="coupon.url" target="_blank">
          <qr-code [value]="coupon.url" name="qrcode"
                   *ngIf="coupon.showCode"
                   style="width:150px;height: 150px"
                   ngxClipboard [cbContent]="coupon.url"
                   [size]="145">
          </qr-code>
        </a>

      </td>
      <td style="text-align: center;vertical-align: top;width:auto;">
        <div style="display:inline-block;font-size: larger;" *ngIf="coupon._id!=coupon.origin">
          {{coupon.gain | number:'1.0-1'}}{{coupon.symbol}} gagné(es)
          <span *ngIf="coupon.max>0 && coupon.gain/coupon.max>0.8">(/{{coupon.max}})</span>
        </div>

        <div *ngIf="coupon.canbedeal && coupon.showCode">
          <br><br>
          <table style="text-align: left;display: inline-block;font-size:small;" cellpadding="2" name="zoneInfo">
            <tr><td>Immédiat</td><td style="text-align: right;">+{{coupon.direct_bonus}}{{coupon.symbol}}</td></tr>
            <tr><td>Partagé</td><td style="text-align: right;">+{{coupon.share_bonus}}{{coupon.symbol}}</td></tr>
            <tr><td>Transformé</td><td style="text-align: right;">+{{coupon.pay_bonus}}{{coupon.symbol}}</td></tr>
            <tr><td>Utilisé</td><td style="text-align: right;">+{{coupon.final_bonus}}{{coupon.symbol}}</td></tr>
          </table><br>
        </div>
        <!--La table des gains-->

        <span style="font-size: medium">
          <br>
            Reste <app-timer [end]="coupon.dtEnd"></app-timer>
          </span>

        <!--Zone réserver au créateur-->
        <div *ngIf="coupon._id==coupon.origin && coupon.owner==user._id && coupon.share>0" style="font-size: small;">
          <br>
          <table style="display:inline-block;text-align: left;">
            <tr>
              <td style="text-align: right;"><strong>{{coupon.share | number:'1.0-0'}}</strong>&nbsp;</td>
              <td>partages (/{{coupon.max_coupon}})</td>
            </tr>
            <tr *ngIf="user.level>1">
              <td style="text-align: right;">{{coupon.gain_total | number:'1.0-1'}} {{coupon.symbol}}</td>
              <td>proposé(es)</td>
            </tr>
            <tr>
              <td style="text-align: right;">{{coupon.stock | number:'1.0-1'}}{{coupon.symbol}}</td>
              <td>
                en stock
                <mat-icon (click)="updateStock(coupon)" style="cursor:pointer;font-size: small;">edit</mat-icon>
              </td>
            </tr>
          </table>

        </div>

      </td>
    </tr></table>


    <app-tuto *ngIf="coupon.showCode && isVisible(coupon)" [delay]="1" [duration]="30"
              label="Le lien du coupon est disponible dans le presse-papier, vous pouvez l'envoyer par WhatsApp, SMS, Messenger ... etc ...">
    </app-tuto>

    <app-tuto [duration]="15" *ngIf="coupon.canbedeal && coupon.origin!=coupon._id"
              label="Augmenter votre réduction en partageant cette réduction avec votre réseau">
    </app-tuto>

    <div style="width: 100%;text-align: center;font-size: medium;color:lightgrey;"
         name="zoneConditions"
         *ngIf="coupon.origin!=coupon._id && coupon.showCode && !coupon.canbedeal">
      <br>
      <strong>Rappel des conditions d'application:</strong><br>
      Offre valable pour {{coupon.conditions}}
    </div>

    <app-tuto *ngIf="!coupon.canbedeal && coupon.origin!=coupon._id"
              label="Le coupon ne peut plus être distribué, mais vous pouvez l'utiliser au près du vendeur">
    </app-tuto>

    <app-tuto *ngIf="coupon.owner==user?._id && coupon.origin==coupon._id" [delay]="10" button="printer"
              label="A tout instant, vous pouvez imprimer une affiche pré-fabriquée pour votre promotion">
    </app-tuto>

    <app-tuto *ngIf="coupon.origin==coupon._id && coupon.share>0 && coupon.canbedeal"
              [delay]="5" button="not_interested"
              label="Vous pouvez interrompre la distribution d'une promotion à tout instant">
    </app-tuto>
    
  </mat-card-content>

  <!--Info sur le coupon-->

  <mat-card-actions class="app-card-action" style="text-align: right;" *ngIf="isVisible(coupon)">


    <div *ngIf="coupon.owner==user?._id">

      <!--<button mat-button mat-flat-button mat-icon-button (click)="showInfos(coupon)">-->
      <!--<mat-icon>attach_money</mat-icon>-->
      <!--</button>-->

      <button *ngIf="user.level>0.8 && coupon._id==coupon.origin && isVisible(coupon) && coupon.canbedeal" mat-button
              (click)="openPrinter(coupon)"
              name="btnPrint"
              title="Imprimer une affiche de votre bon plan"
              mat-flat-button mat-icon-button>
        <mat-icon>printer</mat-icon>
      </button>

      <button *ngIf="user && coupon.shop_complete?.owner!=user._id" mat-button
              (click)="addfollow(user._id,coupon.shop)"
              title="Recevoir les prochaines promotion de '{{coupon.shop_complete?.name}}'"
              mat-flat-button mat-icon-button>

        <mat-icon *ngIf="user && !isfollower(coupon.shop)">add_shopping_cart</mat-icon>
        <mat-icon *ngIf="user && isfollower(coupon.shop)">remove_shopping_cart</mat-icon>
      </button>

      <button *ngIf="user.level>0.5 && coupon._id==coupon.origin && isVisible(coupon) && coupon.canbedeal" mat-button
              (click)="stopDeal(coupon)"
              title="Fermer prématurément la promotion"
              mat-flat-button mat-icon-button>
        <mat-icon>not_interested</mat-icon>
      </button>

      <button mat-button mat-flat-button
              name="btnMap"
              *ngIf="coupon._id!=coupon.origin"
              title="Localiser l'enseigne proposant la réduction"
              mat-icon-button  (click)="showAddress(coupon.shop_complete)">
        <mat-icon>my_location</mat-icon>
      </button>

      <button mat-button mat-flat-button
              mat-icon-button
              name="btnRemove"
              *ngIf="user.level>0.6"
              (click)="remove(coupon)">
        <mat-icon>delete</mat-icon>
      </button>


      <div *ngIf="!coupon.closed" style="display: inline-block;margin:0;padding:0;">

        <button mat-button mat-flat-button
                *ngIf="coupon.website!=null && coupon.website?.length>0"
                mat-icon-button
                name="btnHelp"
                (click)="openHelp(coupon.website)">
          <mat-icon>help</mat-icon>
        </button>

        <button mat-button mat-flat-button
                name="btnShare"
                *ngIf="!coupon.canbedeal || (coupon.origin!=coupon._id && user.level==0)"
                title="Partager le coupon pour augmenter votre promotion / réduction"
                (click)="showCode(coupon)">
          <span *ngIf="coupon.canbedeal">
            Partager
            <span *ngIf="coupon.origin!=coupon._id">/ Utiliser</span>
          </span>
          <!--Lorsque le coupon ne peut plus être distribué on ne peut plus que l'utiliser-->
          <span *ngIf="!coupon.canbedeal && coupon.gain>0">
            Utiliser
          </span>
        </button>

        <button mat-button mat-flat-button mat-icon-button
                name="btnShareAdvanced"
                *ngIf="coupon.canbedeal && user.level>0"
                title="Partager le coupon pour augmenter votre promotion / réduction"
                (click)="showCode(coupon)">
          <mat-icon>share</mat-icon>
        </button>

        <!--<button mat-button mat-flat-button-->
        <!--mat-icon-button (click)="socialSharing(coupon)" >-->
        <!--<span style="font-size: x-large">f</span>-->
        <!--</button>-->

        <!--<button mat-button mat-flat-button-->
        <!--mat-icon-button (click)="socialSharing(coupon)" >-->
        <!--<span style="font-size: large">g+</span>-->
        <!--</button>-->

      </div>
    </div>



    <div *ngIf="coupon.owner!=user?._id">



      <button *ngIf="coupon._id==coupon.origin && isVisible(coupon) && coupon.canbedeal" mat-button
              (click)="flash(coupon)"
              name="btnRecup"
              title="Récupérer ce coupon pour le mettre dans vos promotions"
              mat-flat-button>
        Récupérer
      </button>
    </div>
  </mat-card-actions>
</mat-card>
