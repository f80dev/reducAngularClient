<div *ngFor="let coupon of coupons | orderBy:sort" style="width:100%;padding: 0px;margin-top:3px;">
  <mat-expansion-panel [expanded]="isVisible(coupon)"
                       class="app-card"
                       (closed)="showCoupon(coupon,false)"
                       (opened)="showCoupon(coupon,true)"
                       style="background-color: #8f8f8f;padding:0px"
                       *ngIf="coupon.flip || coupon.visual==null || coupon.visual?.length==0 || coupon.origin==coupon._id">
    <mat-expansion-panel-header collapsedHeight="50px" expandedHeight="50px"
                                class="app-card-header"
                                name="promoTitle">

      <!-- Titre principal du coupon-->
      <div style="width: 100%;margin-left:5px;margin-top:0px;">
        <!--<div style="width: 40px;height:40px;display: inline-block;"-->
             <!--(click)="_flip(coupon)"-->
             <!--class="header-image">-->
        <!--</div>-->

        <!--Affichage des coupon pour la carte-->
        <span *ngIf="coupon.origin==coupon._id && coupon.owner!=user._id">
          {{coupon.shopname}}: {{coupon.label}}<br>
          Gagnez jusqu'à {{coupon.max}}{{coupon.symbol}}
        </span>

          <!--Affichage des coupons origines pour leur propriétaire-->
          <div *ngIf="coupon.origin==coupon._id && coupon.owner==user._id">
            {{coupon.title}}

            <span *ngIf="!isVisible(coupon)">
              &nbsp;&nbsp;- <app-timer [end]="coupon.dtEnd"></app-timer>
            </span>
          </div>


        <!--Affichage des coupons copiés pour les non propriétaire pour la carte-->
          <div *ngIf="coupon.origin!=coupon._id && coupon.owner==user._id">
            {{coupon.label}}<br>
            <span *ngIf="coupon.visible">
              <span style="font-size: x-small;" *ngIf="coupon.canbedeal && coupon.max>0">
                jusqu'à {{coupon.max}}{{coupon.symbol}} offert {{coupon.conditions}}
              </span>

                <!--Si le coupon ne peut plus être distribué-->
              <span *ngIf="!coupon.canbedeal">
                Récupérer {{coupon.gain}}{{coupon.symbol}} offert
              </span>
            </span>

            <span *ngIf="!coupon.visible">
              {{coupon.gain}}{{coupon.symbol}} déjà gagné(es).
              Reste <app-timer [end]="coupon.dtEnd"></app-timer>
            </span>
          </div>


        <!--Affichage des coupons origines pour leur propriétaire-->
        <div *ngIf="coupon.owner==user._id && coupon.origin==coupon._id" style="font-size: small;">
          {{coupon.share}}/{{coupon.max_coupon}} coupons distribués
          <span *ngIf="coupon.max>0 && (coupon.gain/coupon.max)>0.8">
            (max:{{coupon.max}})
          </span>
        </div>

      </div>

    </mat-expansion-panel-header>
        <div style="margin:0px !important;" class="app-card-content">

          <!-- Section destinée à l'imprression -->
          <div id="print-section-{{coupon._id}}" style="display: none;">
            <app-print-coupon [coupon]="coupon"></app-print-coupon>
          </div>

          <!--Visuel du coupon-->
          <table style="width:100%;vertical-align: top;text-align: center;"><tr>
            <td style="text-align: center;width: fit-content;max-width: 40%;">
              <!--Visuel du coupon-->

              <div *ngIf="(coupon.showCode==null || !coupon.showCode) && coupon.picture?.length>0 && (coupon.origin!=coupon._id || config.width_screen>350)">
                <app-visual [picture]="coupon.visual" (click)="coupon.showCode=true" [width]="180" [height]="180"></app-visual>
              </div>

              <!--QRCode du coupon-->

              <a [href]="coupon.url" target="_blank">
                <qr-code [value]="coupon.url" name="qrcode"
                         *ngIf="coupon.showCode"
                         style="width:150px;height: 150px"
                         ngxClipboard [cbContent]="coupon.url"
                         [size]="120">
                </qr-code>
              </a>

            </td>
            <td style="text-align: center;vertical-align: top;width:auto;">

              <!--Zone réservé au client de base-->
              <div style="margin-top:15px;display:inline-block;font-size: larger;" *ngIf="coupon._id!=coupon.origin && !coupon.showCode">
                <span style="font-size: 2em">
                  {{coupon.gain | number:'1.0-1'}}{{coupon.symbol}}
                </span>
                <br>
                <span style="font-size: x-small;margin:0;padding: 0;">gagné(es)</span>
                <span *ngIf="coupon.max>0 && coupon.gain/coupon.max>0.8">(/{{coupon.max}})</span>
              </div>


              <div *ngIf="coupon.canbedeal && coupon.showCode">
                <table style="text-align: left;display: inline-block;font-size:small;" cellpadding="2" name="zoneInfo">
                  <tr><td>Immédiat</td><td style="text-align: right;">+{{coupon.direct_bonus}}{{coupon.symbol}}</td></tr>
                  <tr><td>Partagé</td><td style="text-align: right;">+{{coupon.share_bonus | number:'1.0-1'}}{{coupon.symbol}}</td></tr>
                  <tr><td>Transformé</td><td style="text-align: right;">+{{coupon.pay_bonus}}{{coupon.symbol}}</td></tr>
                  <tr><td>Utilisé</td><td style="text-align: right;">+{{coupon.final_bonus}}{{coupon.symbol}}</td></tr>
                </table><br>
              </div>
              <!--La table des gains-->
              <span style="font-size: medium" *ngIf="!coupon.showCode">
                <br><br>
                Reste <app-timer [end]="coupon.dtEnd"></app-timer>
              </span>

              <!--Zone réserver au créateur-->
              <div *ngIf="coupon._id==coupon.origin && coupon.owner==user._id && coupon.share>0" style="font-size: small;">
                <br>
                <table style="display:inline-block;text-align: left;">
                  <tr>
                    <td style="text-align: right;"><strong>{{coupon.share | number:'1.0-0'}}</strong>&nbsp;</td>
                    <td>partages (/{{coupon.max_coupon}})</td>
                  </tr>
                  <tr *ngIf="user.level>1">
                    <td style="text-align: right;">{{coupon.gain_total | number:'1.0-1'}} {{coupon.symbol}}</td>
                    <td>proposé(es)</td>
                  </tr>
                  <tr>
                    <td style="text-align: right;">{{coupon.stock | number:'1.0-1'}}{{coupon.symbol}}</td>
                    <td>
                      en stock
                      <mat-icon (click)="updateStock(coupon)" style="cursor:pointer;font-size: small;">edit</mat-icon>
                    </td>
                  </tr>
                </table>

              </div>

            </td>
          </tr></table>


          <app-tuto *ngIf="coupon.showCode && isVisible(coupon)" [delay]="1" [duration]="30"
                    label="Le lien du coupon est disponible dans le presse-papier, vous pouvez l'envoyer par WhatsApp, SMS, Messenger ... etc ...">
          </app-tuto>

          <app-tuto [duration]="15" *ngIf="coupon.canbedeal && coupon.origin!=coupon._id"
                    label="Augmenter votre réduction en partageant cette réduction avec votre réseau">
          </app-tuto>

          <div style="width: 100%;text-align: center;font-size: medium;color:lightgrey;"
               name="zoneConditions"
               *ngIf="coupon.origin!=coupon._id && coupon.showCode && !coupon.canbedeal">
            <br>
            <strong>Rappel des conditions d'application:</strong><br>
            Offre valable pour {{coupon.conditions}}
          </div>

          <app-tuto *ngIf="!coupon.canbedeal && coupon.origin!=coupon._id"
                    label="Le coupon ne peut plus être distribué, mais vous pouvez l'utiliser au près du vendeur">
          </app-tuto>

          <app-tuto *ngIf="user.level>0.8 && coupon.owner==user?._id && coupon.origin==coupon._id" [delay]="10" button="printer"
                    label="A tout instant, vous pouvez imprimer une affiche pré-fabriquée pour votre promotion">
          </app-tuto>

          <app-tuto *ngIf="coupon.origin==coupon._id && coupon.share>0 && coupon.canbedeal && coupon['flip']"
                    [delay]="5" button="not_interested"
                    label="Vous pouvez interrompre la distribution d'une promotion à tout instant">
          </app-tuto>

        </div>


    <!--Info sur le coupon-->

    <mat-action-row class="app-card-action">

      <div *ngIf="coupon.owner==user?._id">

        <!--<button mat-button mat-flat-button mat-icon-button (click)="showInfos(coupon)">-->
        <!--<mat-icon>attach_money</mat-icon>-->
        <!--</button>-->

        <button *ngIf="user.level>0.8 && coupon._id==coupon.origin && isVisible(coupon) && coupon.canbedeal"
                class="small-icon-button"
                mat-button
                (click)="openPrinter(coupon)"
                name="btnPrint"
                title="Imprimer une affiche de votre bon plan"
                mat-flat-button mat-icon-button>
          <mat-icon>printer</mat-icon>
        </button>

        <button *ngIf="user && coupon.shop_complete?.owner!=user._id"
                mat-button
                mat-flat-button mat-icon-button
                class="small-icon-button"
                (click)="addfollow(user._id,coupon.shop)"
                title="Recevoir les prochaines promotion de '{{coupon.shop_complete?.name}}'">
          <mat-icon *ngIf="user && !isfollower(coupon.shop)">favorite</mat-icon>
          <mat-icon *ngIf="user && isfollower(coupon.shop)">remove_shopping_cart</mat-icon>
        </button>

        <button *ngIf="user.level>0.5 && coupon._id==coupon.origin && isVisible(coupon) && coupon.canbedeal"
                mat-button
                (click)="stopDeal(coupon)"
                class="small-icon-button"
                title="Fermer prématurément la promotion"
                mat-flat-button mat-icon-button>
          <mat-icon>not_interested</mat-icon>
        </button>

        <button mat-button mat-flat-button
                name="btnMap"
                class="small-icon-button"
                *ngIf="coupon._id!=coupon.origin"
                title="Localiser l'enseigne proposant la réduction"
                mat-icon-button  (click)="showAddress(coupon.shop_complete)">
          <mat-icon>my_location</mat-icon>
        </button>

        <button mat-button mat-flat-button
                mat-icon-button
                class="small-icon-button"
                name="btnRemove"
                *ngIf="user.level>0.6"
                (click)="remove(coupon)">
          <mat-icon>delete</mat-icon>
        </button>

        <button mat-button mat-flat-button
                mat-icon-button
                class="small-icon-button"
                name="btnEdit"
                *ngIf="coupon.share==0 && coupon.origin==coupon._id"
                (click)="onedit.emit(coupon)">
          <mat-icon>create</mat-icon>
        </button>


        <div *ngIf="!coupon.closed" style="display: inline-block;margin:0;padding:0;">
          <button mat-button mat-flat-button
                  *ngIf="coupon.website!=null && coupon.website?.length>0 && coupon.owner!=user._id"
                  mat-icon-button
                  class="small-icon-button"
                  name="btnHelp"
                  (click)="openHelp(coupon.website)">
            <mat-icon>help</mat-icon>
          </button>

          <button mat-button mat-flat-button
                  name="btnShare"
                  *ngIf="coupon.canbedeal && user.level<1"
                  title="Partager le coupon pour augmenter votre promotion / réduction"
                  (click)="showCode(coupon)">
            <mat-icon>share</mat-icon>&nbsp;
            <span *ngIf="coupon.origin!=coupon._id">
              Gagner plus
            </span>

            <span *ngIf="coupon.origin==coupon._id">
              Distribuer
            </span>

          </button>

          <button mat-button mat-flat-button mat-icon-button
                  name="btnShareAdvanced"
                  class="small-icon-button"
                  *ngIf="coupon.canbedeal && user.level>=1"
                  title="Partager le coupon pour augmenter votre promotion / réduction"
                  (click)="showCode(coupon)">
            <mat-icon>share</mat-icon>
          </button>

          <button mat-button mat-flat-button mat-icon-button
                  name="btnUseAdvanced"
                  *ngIf="coupon.origin!=coupon._id && user.level>0.8"
                  title="Utiliser votre coupon pour avoir votre réduction"
                  (click)="showCode(coupon)">
            <mat-icon>done</mat-icon>&nbsp;
          </button>

          <button mat-button mat-flat-button
                  name="btnUse"
                  *ngIf="coupon.origin!=coupon._id && user.level<=0.8"
                  title="Utiliser votre coupon pour avoir votre réduction"
                  (click)="showCode(coupon)">
            Utiliser
          </button>


        </div>
      </div>

      <div *ngIf="coupon.owner!=user?._id">
        <button *ngIf="coupon._id==coupon.origin && isVisible(coupon) && coupon.canbedeal" mat-button
                (click)="flash(coupon)"
                name="btnRecup"
                title="Récupérer ce coupon pour le mettre dans vos promotions"
                mat-flat-button>
          Récupérer
        </button>
      </div>
    </mat-action-row>
  </mat-expansion-panel>

  <div class="visual-coupon" *ngIf="!coupon.flip && coupon.visual?.length>0 && coupon.origin!=coupon._id" (click)="_flip(coupon)">
    <img [src]="coupon.visual" style="position:absolute;z-index:0;top:0;left:0;width:100%;height:100%;object-fit: cover;object-position: 50% 50%;">
    <div style="z-index: 100;position: absolute;left:10%;top:10%;width:80%;max-width: 500px;font-size:x-large;">
      {{coupon.label}}<br><br>
      <span style="font-size:large;" *ngIf="coupon.max>0">
        Vous avez {{coupon.gain}}{{coupon.symbol}}<br>
        <small>(vous pouvez avoir jusqu'à {{coupon.max}}{{coupon.symbol}})</small>
      </span>
    </div>
    <div style="z-index: 110;position: absolute;left:0;top:75%;width:100%;text-align: right;max-width:720px;">
      <button *ngIf="user.level<1 && coupon._id!=coupon.origin"
              style="display: inline-block;margin-right:40px;"
              mat-button
              name="btnInfo"
              title="Avoir le détail de la promo"
              mat-flat-button>
        En savoir plus
      </button>
    </div>
  </div>

</div>



